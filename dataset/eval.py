import json
import os


def purity(real_buckets, BUCKETS, flag=False):
    buckets = []
    if not flag:
        for bucket in BUCKETS:
            tmp_bucket = []
            for stack in bucket:
                tmp_bucket.append(stack)
            buckets.append(tmp_bucket)
    else:
        buckets = BUCKETS

    N = 0.0
    for bucket in real_buckets:
        N += len(bucket)

    purity = 0.0
    for j in range(0, len(buckets)):
        pur = []
        for i in range(0, len(real_buckets)):
            Li_Cj = len(list(set(real_buckets[i]).intersection(set(buckets[j]))))
            precision = float(Li_Cj) / float(len(buckets[j]))
            pur.append(precision)
        purity += float(len(buckets[j])) * float(max(pur)) / float(N)
    return purity


def inverse_purity(real_buckets, BUCKETS, flag=False):
    buckets = []
    if not flag:
        for bucket in BUCKETS:
            tmp_bucket = []
            for stack in bucket:
                tmp_bucket.append(stack)
            buckets.append(tmp_bucket)
    else:
        buckets = BUCKETS

    N = 0.0
    for bucket in real_buckets:
        N += len(bucket)

    inverse_purity = 0.0
    for i in range(0, len(real_buckets)):
        inverse_pur = []
        for j in range(0, len(buckets)):
            Li_Cj = len(list(set(real_buckets[i]).intersection(set(buckets[j]))))
            recall = float(Li_Cj) / float(len(real_buckets[i]))
            inverse_pur.append(recall)
        inverse_purity += float(len(real_buckets[i])) * float(max(inverse_pur)) / float(N)
    return inverse_purity


def wrong(real_buckets, BUCKETS, flag=False):
    buckets = []
    if not flag:
        for bucket in BUCKETS:
            tmp_bucket = []
            for stack in bucket:
                tmp_bucket.append(stack)
            buckets.append(tmp_bucket)
    else:
        buckets = BUCKETS

    N = 0.0
    for bucket in real_buckets:
        N += len(bucket)
    wrong_set = []
    for j in range(0, len(buckets)):
        found = False
        for i in range(0, len(real_buckets)):
            if set(buckets[j]).issubset(set(real_buckets[i])):
                found = True
        if not found:
            wrong_set.append(buckets[j])

    real_set = []

    for bucket in wrong_set:
        for stack in bucket:
            for real_bucket in real_buckets:
                if stack in real_bucket:
                    if real_bucket not in real_set:
                        real_set.append(real_bucket)
    debug = False
    if debug:
        for bucket in wrong_set:
            for stack in bucket:
                for real_bucket in real_buckets:
                    if stack in real_bucket:
                        print("Real bucket is " + str(real_bucket))
            print("Wrong bucket is " + str(bucket))

    return len(real_set) - len(wrong_set)


def meature_result(real_buckets, BUCKETS, flag=False):
    buckets = []
    if not flag:
        for bucket in BUCKETS:
            tmp_bucket = []
            for stack in bucket:
                tmp_bucket.append(stack)
            buckets.append(tmp_bucket)
    else:
        buckets = BUCKETS

    N = 0.0
    for bucket in real_buckets:
        N += len(bucket)

    fmeasure = 0.0
    for i in range(0, len(real_buckets)):
        f = []
        for j in range(0, len(buckets)):
            Li_Cj = len(list(set(real_buckets[i]).intersection(set(buckets[j]))))
            precision = float(Li_Cj) / float(len(buckets[j]))
            recall = float(Li_Cj) / float(len(real_buckets[i]))
            if precision == 0 or recall == 0:
                f.append(0)
            else:
                f.append(float((2 * precision * recall) / (precision + recall)))
        fmeasure += float(len(real_buckets[i])) * float(max(f)) / float(N)
    return fmeasure


if __name__ == '__main__':
    f_r = open('tmp3.json', 'r')
    real_buckets = json.load(f_r)
    f_r.close()

    # f_r = open('', 'r')
    # rebuckets = json.load(f_r)
    # f_r.close()
    #
    real_buckets = real_buckets[:1000]
    re_buckets = [['100032', '126166', '100053'], ['100085'], ['100090'], ['100133'], ['100162'], ['100224'], ['97027'], ['100233'], ['100303', '101628'], ['10031'], ['100310'], ['100320'], ['100356'], ['100375'], ['100454'], ['100494', '99978'], ['100527'], ['100558'], ['100614'], ['100622'], ['100634'], ['10064'], ['100643'], ['100657'], ['100677', '105151'], ['100678'], ['100691'], ['100701'], ['100704', '101268'], ['100729'], ['100765'], ['100795'], ['100799'], ['100821'], ['100879'], ['100919'], ['100937', '152468'], ['100980'], ['100982', '101791'], ['101087'], ['101183'], ['101212'], ['101228'], ['101230'], ['101262', '101318', '101351'], ['101271'], ['101272', '101333'], ['101284'], ['101342'], ['101408'], ['101424', '101430'], ['101453'], ['101484'], ['10151'], ['101521'], ['101547'], ['101553', '93780'], ['101559', '102317'], ['101580'], ['101632'], ['101657'], ['101673', '98595'], ['101676'], ['101713', '92165', '102265', '108905', '110403', '149042'], ['101722'], ['101768'], ['101779', '105524'], ['101820'], ['101835'], ['101840'], ['101848'], ['101865'], ['101892'], ['101921'], ['101929', '57298'], ['101955'], ['102004', '102565'], ['102009'], ['102036', '102037'], ['102054'], ['102096'], ['102117', '102502', '116941'], ['102124', '83234'], ['102149'], ['102181', '102278', '108095'], ['102199'], ['10223'], ['102301'], ['102310'], ['102315'], ['102332'], ['102351'], ['102357'], ['102367'], ['102375'], ['102467', '102468'], ['102558'], ['10268'], ['102755'], ['102820'], ['102876'], ['102909'], ['102951'], ['103046'], ['103051'], ['103063'], ['103066', '100520', '100521'], ['103097'], ['103123'], ['103136', '131564'], ['103146'], ['103159'], ['10320'], ['103203'], ['103277'], ['103308', '103456'], ['103320', '103336'], ['103355', '105461'], ['103363', '103366'], ['103371'], ['103372'], ['103374', '44438', '131161'], ['103479'], ['103517'], ['103528'], ['103598'], ['103628'], ['103676'], ['103689'], ['103740'], ['103775'], ['103781'], ['103792'], ['103795'], ['103802'], ['103807'], ['103812'], ['103826'], ['103879'], ['103883'], ['103889'], ['103982', '109525'], ['103983'], ['104010', '151853'], ['104023'], ['104064'], ['104159'], ['104169'], ['10418'], ['104181'], ['104208'], ['104239'], ['10424'], ['104249'], ['104338', '105787'], ['104343'], ['104466'], ['10447'], ['104486', '106828'], ['104492', '106907', '106908'], ['104502'], ['104551'], ['104574'], ['104629'], ['104649'], ['104657'], ['10466'], ['104720'], ['104738'], ['104788'], ['104798'], ['104828'], ['104866'], ['104879'], ['104882'], ['104896'], ['104917'], ['104931'], ['104947'], ['104957'], ['104960'], ['104993', '122613', '127722'], ['105082'], ['105095', '105456', '108261'], ['105111'], ['105172'], ['105175'], ['105181'], ['105200'], ['105207'], ['105246'], ['105306'], ['105335'], ['10535'], ['105396'], ['105459'], ['105462', '105783'], ['105466', '336035'], ['105562'], ['10557', '9450'], ['105581'], ['105624'], ['10572'], ['105752', '105753'], ['105758'], ['105759'], ['10597'], ['106063'], ['106102'], ['106127'], ['106164'], ['106293'], ['106319'], ['106377'], ['106459'], ['106463'], ['106525'], ['106541'], ['106555', '158244'], ['106565'], ['106568', '106133'], ['106619'], ['106627'], ['10663'], ['106645'], ['106648'], ['106649', '120455'], ['106660'], ['106665'], ['106692'], ['106696'], ['106715', '106716'], ['106748'], ['106754'], ['106758'], ['106826'], ['106871'], ['106874', '109124'], ['106896'], ['106897'], ['106925'], ['106944'], ['106964'], ['106989'], ['107012'], ['107026'], ['107072'], ['107083'], ['107147'], ['107149'], ['107150'], ['107151'], ['107159'], ['107180'], ['107185'], ['107187'], ['107209'], ['107240'], ['107260'], ['107287'], ['107299'], ['107321'], ['107329'], ['107462'], ['107469'], ['107530'], ['107643'], ['107680'], ['107696'], ['107716'], ['107735', '108089', '108252'], ['107775'], ['107784'], ['107809'], ['107907'], ['107944'], ['107953', '107956'], ['107972'], ['107977'], ['107979', '107196'], ['108069'], ['108090'], ['108093'], ['108097'], ['108107', '108432'], ['108127'], ['10815'], ['108156'], ['10821'], ['108218', '108915'], ['108221'], ['108325', '108333'], ['108370'], ['108377'], ['108497'], ['108504'], ['108519'], ['108542'], ['108544'], ['108569'], ['10857'], ['108574'], ['108575'], ['108602'], ['108638'], ['108656'], ['108669'], ['108714'], ['108740'], ['108772'], ['108783'], ['108787', '83582'], ['108836'], ['108837', '115830', '115900'], ['10885'], ['108856', '114266'], ['108958', '110230'], ['108973'], ['108995', '120946'], ['109054'], ['109055'], ['109069', '120906', '134227'], ['109199', '162405'], ['109243'], ['109244'], ['109250'], ['109263'], ['109311'], ['109334'], ['109376'], ['109463'], ['109465'], ['109486'], ['109493'], ['109497'], ['109522'], ['109558'], ['109604'], ['109614'], ['109632'], ['109642'], ['109679'], ['10970'], ['109707'], ['109716'], ['109719'], ['109771'], ['109772'], ['109941'], ['109950'], ['109954'], ['109969'], ['109991'], ['110132'], ['110205'], ['110229'], ['110234'], ['110236'], ['110269'], ['110352'], ['110361', '120127'], ['110364', '116559'], ['110369'], ['110370'], ['11039'], ['110396'], ['110406'], ['110413', '58367'], ['110466'], ['110475'], ['110484'], ['110630'], ['110674'], ['110738'], ['110767'], ['110772'], ['110826'], ['110828'], ['110837', '134961'], ['110866'], ['110879'], ['110903'], ['110941'], ['110997', '110859'], ['111010'], ['111082'], ['111092', '113624'], ['111166'], ['111193'], ['111211'], ['111312'], ['111466'], ['111579'], ['111621'], ['111632'], ['111649'], ['111654'], ['111703'], ['111717', '114167'], ['111750'], ['111764'], ['111823'], ['111858'], ['111886'], ['111904'], ['111922'], ['111924'], ['111927'], ['111967'], ['112004'], ['112007'], ['112038'], ['112076'], ['112083'], ['112091'], ['112125'], ['112132'], ['112165'], ['112169', '170085'], ['112200'], ['112243'], ['112290'], ['112294'], ['112383'], ['112459'], ['112464'], ['112514'], ['112587'], ['112615'], ['112626'], ['112703', '113958'], ['112749'], ['11275'], ['112783'], ['112806'], ['112825'], ['112829'], ['112888'], ['112892'], ['112932'], ['113013'], ['113062'], ['113066'], ['113078'], ['113089'], ['113111'], ['113165'], ['113211'], ['113240', '120394'], ['113248'], ['11325'], ['113252'], ['113273', '114365'], ['113285'], ['113309'], ['113342', '151344'], ['113351'], ['11338'], ['113429'], ['113490'], ['113527'], ['113538'], ['113571'], ['113596'], ['113627'], ['113662'], ['113777'], ['113780'], ['11379'], ['113796'], ['113861'], ['113870'], ['113888'], ['113916'], ['113933'], ['11398'], ['114051'], ['11406'], ['114066'], ['114103'], ['114138'], ['114143'], ['11424'], ['11431'], ['114371'], ['114390'], ['114423'], ['114436'], ['114449'], ['114466'], ['114476'], ['114481'], ['114518'], ['114541'], ['114550'], ['114571', '118444', '119081', '190563'], ['114652'], ['114685'], ['114715'], ['114717'], ['114724'], ['114745'], ['114781'], ['114855'], ['114863'], ['114869', '114871'], ['114877'], ['114882'], ['114917'], ['114925'], ['114955', '123360', '128114'], ['11497'], ['114987'], ['114998'], ['115038'], ['115051'], ['115065'], ['115083'], ['115090'], ['115117'], ['11517'], ['115196'], ['115261'], ['115262'], ['115275'], ['115277', '131322'], ['115303'], ['115305'], ['115332'], ['115373'], ['115408'], ['115546'], ['115605'], ['115636'], ['115683'], ['115787'], ['115822'], ['115871'], ['115906'], ['11604'], ['116056'], ['116075'], ['116114'], ['116117'], ['116221'], ['116252', '120724', '142352'], ['11627', '11860'], ['116305'], ['116311'], ['116332'], ['116340'], ['116355'], ['116370'], ['116385'], ['116386'], ['116406'], ['11645'], ['116453'], ['116463'], ['116547'], ['116561'], ['116576'], ['116578'], ['116579'], ['116653'], ['116700'], ['116713'], ['116741'], ['116756', '116774'], ['116762'], ['116772'], ['116851', '116874'], ['116862'], ['116935'], ['116940'], ['116956'], ['116959'], ['117047'], ['117051'], ['117119'], ['117121'], ['117138'], ['117173'], ['117182'], ['117209', '117210'], ['117240'], ['117247'], ['117268'], ['117314'], ['117328', '118782'], ['117361'], ['117398'], ['117412'], ['117413'], ['117430'], ['117438'], ['117442'], ['117472'], ['117614'], ['117644'], ['117662'], ['117674'], ['117681'], ['117707'], ['117729'], ['117780'], ['117826'], ['117854'], ['117861'], ['117893'], ['117923'], ['117928', '118058', '118695', '118893', '119079'], ['117946'], ['11797', '11814'], ['118051'], ['118052'], ['118067'], ['118076'], ['118084'], ['118090'], ['118104'], ['118119'], ['118158'], ['118160'], ['118232'], ['118329', '118539'], ['118341'], ['118342'], ['118353'], ['118361'], ['118363'], ['118387'], ['118423'], ['118548'], ['118585'], ['118593'], ['118625'], ['118689'], ['118708'], ['118770'], ['118798'], ['118820'], ['118872'], ['118905'], ['118915'], ['118922'], ['118937'], ['118961'], ['119010'], ['119019'], ['119078'], ['119086'], ['119111', '103221', '120731', '121219', '123132', '127468', '128930', '137673'], ['119128', '114026'], ['119129'], ['119156'], ['119160'], ['119167'], ['119175'], ['11919'], ['119210'], ['119214'], ['119236'], ['119254'], ['119268'], ['119270'], ['119291'], ['11932'], ['119325'], ['119356'], ['119394'], ['11941', '12545'], ['119440'], ['119448', '126170'], ['119532'], ['119545'], ['119588', '120146', '121195', '176376'], ['119611'], ['119680'], ['119741', '121648'], ['119750'], ['119781'], ['119867'], ['119877'], ['119884'], ['119934'], ['119939'], ['119954', '85823', '107546', '118288', '119969', '120132', '120133'], ['119956'], ['119975'], ['119978'], ['120015'], ['120024'], ['120028'], ['120044'], ['120130'], ['120208'], ['120255'], ['120289'], ['120294'], ['120300'], ['120318'], ['120321'], ['120323'], ['120351'], ['120432'], ['120493'], ['120515'], ['120559'], ['120573'], ['120597'], ['12060'], ['120621'], ['120625'], ['120646'], ['120672'], ['120709', '123908'], ['120722'], ['120797'], ['120823'], ['120826'], ['120940'], ['120977'], ['12098'], ['12108'], ['121096'], ['121109', '121491', '121879'], ['121175'], ['121189', '121416'], ['121199'], ['121283'], ['121286'], ['121289'], ['121296'], ['121302'], ['121308'], ['121326', '121381', '121436'], ['121369', '156765', '158531', '174447'], ['121374'], ['121395'], ['121441'], ['121480'], ['121483', '127949', '130517'], ['121486'], ['121533'], ['121557', '122113'], ['121575'], ['121631'], ['121643'], ['121701'], ['121707'], ['121708'], ['121742'], ['121772'], ['121805'], ['121857'], ['121865'], ['121900'], ['121911'], ['121931'], ['121954'], ['122006'], ['12204', '11288'], ['122068', '122073'], ['122127'], ['122131'], ['122171'], ['122240'], ['122259'], ['122264', '122870'], ['122291'], ['122312'], ['122319', '101475'], ['122322', '142538', '204432'], ['122371'], ['122379'], ['122394'], ['122494'], ['122504'], ['122505'], ['122534', '122535', '122541'], ['122547'], ['122610', '163262'], ['122653'], ['122735'], ['122737', '122889'], ['122739'], ['122742'], ['122744'], ['122746', '124326', '128241'], ['122817'], ['122864'], ['122872'], ['122888'], ['122930'], ['122988'], ['123005'], ['123056', '123095'], ['123069'], ['12309'], ['123098', '222848'], ['123155'], ['123166'], ['123270'], ['123341'], ['123342'], ['123383'], ['123390'], ['123397'], ['123414'], ['123427'], ['123559'], ['123568'], ['123571'], ['123636'], ['123660'], ['123684'], ['123687'], ['123705'], ['123731'], ['123732'], ['123743'], ['123752'], ['123754'], ['123777'], ['12387'], ['123928'], ['123943'], ['123995'], ['123996'], ['124032'], ['124157'], ['124188'], ['124198'], ['124214'], ['124295'], ['124331'], ['124354'], ['124386'], ['124448'], ['124465'], ['124484'], ['12451'], ['124550'], ['124553'], ['124582'], ['124587'], ['124594'], ['124610'], ['124646', '285754'], ['124659'], ['124690'], ['12470'], ['124719'], ['124723'], ['124727'], ['124728'], ['124853'], ['12489'], ['124897'], ['124933', '75994'], ['124969'], ['124975'], ['124999'], ['125034'], ['125080'], ['125145'], ['125152'], ['125191'], ['125279'], ['125349'], ['125354'], ['125357'], ['12539'], ['125399'], ['125431', '125460'], ['125475'], ['125492'], ['125513'], ['125519'], ['125524'], ['125545'], ['125570'], ['125577', '184164'], ['12561', '12848', '13872'], ['125612'], ['125630'], ['125716'], ['125852'], ['125946'], ['125994'], ['126018'], ['126087'], ['126110'], ['126145'], ['126148', '126309'], ['126153'], ['126167'], ['126187'], ['126322'], ['126355'], ['126408'], ['12641'], ['126423', '126424'], ['126496'], ['126564'], ['126567'], ['126591'], ['126683'], ['126700', '127268'], ['126787'], ['126819'], ['126827', '126829'], ['12683', '15171'], ['126881'], ['126957'], ['126995'], ['127018'], ['127032'], ['127042'], ['127124'], ['12714'], ['127204'], ['127238'], ['127292'], ['127293'], ['127299'], ['127312'], ['127323', '120347'], ['127346'], ['127360', '128265', '128751'], ['12739'], ['127423'], ['127424'], ['127472'], ['127473'], ['127478'], ['127506'], ['127545', '127248'], ['127659'], ['127665'], ['127728', '150672', '152879'], ['127777'], ['127816'], ['127870'], ['127904'], ['127910', '128466'], ['127938'], ['127948'], ['127975'], ['128039', '128040'], ['128060'], ['128064'], ['128079'], ['128237'], ['128261'], ['128295'], ['128302'], ['128419', '211053', '213845'], ['128423', '130257'], ['128470'], ['128477'], ['128486'], ['128496'], ['128498'], ['128507'], ['128519'], ['128591'], ['128604'], ['128703'], ['128775'], ['128795'], ['128796'], ['128809', '128736'], ['128815'], ['128836'], ['128850'], ['128873'], ['128885'], ['128921'], ['128922'], ['128936'], ['128942', '130167'], ['128952', '128577'], ['128960'], ['12897'], ['128998'], ['129044'], ['129156', '129052'], ['129195'], ['129240'], ['129282'], ['129292'], ['129313'], ['12937'], ['129448'], ['129462'], ['129490', '135420', '139429', '142886', '142943', '146301', '150267'], ['12955', '12991']]

    print("F = " + str(meature_result(real_buckets, re_buckets)))
    print("purity = " + str(purity(real_buckets, re_buckets)))
    print("inverse_purity = " + str(inverse_purity(real_buckets, re_buckets)))
    print("Wrong = " + str(wrong(real_buckets, re_buckets)))
